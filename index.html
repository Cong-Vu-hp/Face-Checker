<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng ƒêi·ªÉm danh Offline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            transition: all 0.3s;
            color: #495057;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #video, #video2, .preview-image {
            width: 100%;
            display: block;
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-flip {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .student-item:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            color: #212529;
            margin-bottom: 5px;
        }

        .student-id {
            color: #6c757d;
            font-size: 14px;
        }

        .btn-delete {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            font-weight: 600;
            white-space: pre-line;
            line-height: 1.6;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .attendance-record {
            padding: 12px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .attendance-time {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .tab {
                font-size: 12px;
                padding: 12px 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì H·ªá th·ªëng ƒêi·ªÉm danh</h1>
            <p>Nh·∫≠n di·ªán khu√¥n m·∫∑t - Offline</p>
            <span class="badge">üíæ L∆∞u tr·ªØ c·ª•c b·ªô</span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('attendance')">ƒêi·ªÉm danh</button>
            <button class="tab" onclick="switchTab('addStudent')">Th√™m HS</button>
            <button class="tab" onclick="switchTab('manage')">Qu·∫£n l√Ω</button>
            <button class="tab" onclick="switchTab('history')">L·ªãch s·ª≠</button>
        </div>

        <div class="content">
            <!-- Tab ƒêi·ªÉm danh -->
            <div id="attendance" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">H·ªçc sinh</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div class="stat-label">ƒê√£ ƒëi·ªÉm danh</div>
                    </div>
                </div>
                <div class="camera-container">
                    <video id="video" autoplay></video>
                    <button class="btn-flip" onclick="flipCamera()" title="Chuy·ªÉn camera">üîÑ</button>
                </div>
                <div id="attendanceStatus"></div>
                <button class="btn btn-primary" onclick="startCamera()">B·∫≠t Camera</button>
                <button class="btn btn-success" onclick="takeAttendance()">ƒêi·ªÉm danh</button>
                <button class="btn btn-warning" onclick="exportToCSV()">Xu·∫•t CSV</button>
            </div>

            <!-- Tab Th√™m h·ªçc sinh -->
            <div id="addStudent" class="tab-content">
                <div class="camera-container">
                    <video id="video2" autoplay></video>
                    <canvas id="canvas2" style="display:none;"></canvas>
                    <img id="capturedImage" class="preview-image" style="display:none;">
                    <button class="btn-flip" onclick="flipCamera2()" title="Chuy·ªÉn camera">üîÑ</button>
                </div>
                <div id="addStudentStatus"></div>
                <div class="form-group">
                    <label>M√£ h·ªçc sinh</label>
                    <input type="text" id="studentId" placeholder="Nh·∫≠p m√£ h·ªçc sinh">
                </div>
                <div class="form-group">
                    <label>H·ªç v√† t√™n</label>
                    <input type="text" id="studentName" placeholder="Nh·∫≠p h·ªç v√† t√™n">
                </div>
                <div class="form-group">
                    <label>L·ªõp</label>
                    <input type="text" id="studentClass" placeholder="Nh·∫≠p l·ªõp">
                </div>
                <button class="btn btn-primary" onclick="startCamera2()">B·∫≠t Camera</button>
                <button class="btn btn-warning" onclick="capturePhoto()">Ch·ª•p ·∫£nh</button>
                <button class="btn btn-success" onclick="saveStudent()">L∆∞u h·ªçc sinh</button>
            </div>

            <!-- Tab Qu·∫£n l√Ω -->
            <div id="manage" class="tab-content">
                <h3 style="margin-bottom: 15px;">Danh s√°ch h·ªçc sinh</h3>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-bottom: 15px;">üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
                <div class="student-list" id="studentList"></div>
            </div>

            <!-- Tab L·ªãch s·ª≠ -->
            <div id="history" class="tab-content">
                <h3 style="margin-bottom: 15px;">L·ªãch s·ª≠ ƒëi·ªÉm danh h√¥m nay</h3>
                <button class="btn btn-warning" onclick="exportToCSV()" style="margin-bottom: 15px;">Xu·∫•t CSV</button>
                <div id="attendanceHistory"></div>
            </div>
        </div>
    </div>

    <script>
        let videoStream = null;
        let videoStream2 = null;
        let currentFacingMode = 'user';
        let currentFacingMode2 = 'user';
        let capturedImageData = null;

        // Database functions s·ª≠ d·ª•ng LocalStorage
        const DB = {
            getStudents() {
                const data = localStorage.getItem('students');
                return data ? JSON.parse(data) : {};
            },
            
            saveStudents(students) {
                localStorage.setItem('students', JSON.stringify(students));
            },
            
            getAttendance() {
                const data = localStorage.getItem('attendance');
                return data ? JSON.parse(data) : [];
            },
            
            saveAttendance(attendance) {
                localStorage.setItem('attendance', JSON.stringify(attendance));
            }
        };

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'manage') {
                loadStudentList();
            } else if (tabName === 'history') {
                loadAttendanceHistory();
            } else if (tabName === 'attendance') {
                updateStats();
            }
        }

        async function startCamera() {
            try {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p camera
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('video');
                videoElement.srcObject = videoStream;
                
                // ƒê·∫£m b·∫£o video ƒë∆∞·ª£c play
                videoElement.play().catch(err => {
                    console.log('Video play error:', err);
                });
                
                showStatus('attendanceStatus', '‚úì Camera ƒë√£ b·∫≠t th√†nh c√¥ng', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                let errorMsg = 'Kh√¥ng th·ªÉ truy c·∫≠p camera. ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg += 'Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c.';
                } else {
                    errorMsg += error.message;
                }
                
                showStatus('attendanceStatus', errorMsg, 'error');
                
                // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n chi ti·∫øt
                setTimeout(() => {
                    showStatus('attendanceStatus', 
                        'üì± H∆∞·ªõng d·∫´n c·∫•p quy·ªÅn:\n' +
                        '1. Nh·∫•n v√†o icon kh√≥a/th√¥ng tin b√™n tr√°i thanh ƒë·ªãa ch·ªâ\n' +
                        '2. T√¨m m·ª•c "Camera" v√† ch·ªçn "Cho ph√©p"\n' +
                        '3. T·∫£i l·∫°i trang v√† th·ª≠ l·∫°i', 
                        'error'
                    );
                }, 6000);
            }
        }

        async function startCamera2() {
            try {
                if (videoStream2) {
                    videoStream2.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode2,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                videoStream2 = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('video2');
                videoElement.srcObject = videoStream2;
                videoElement.style.display = 'block';
                
                videoElement.play().catch(err => {
                    console.log('Video play error:', err);
                });
                
                document.getElementById('capturedImage').style.display = 'none';
                showStatus('addStudentStatus', '‚úì Camera ƒë√£ b·∫≠t th√†nh c√¥ng', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                let errorMsg = 'Kh√¥ng th·ªÉ truy c·∫≠p camera. ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg += 'Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c.';
                } else {
                    errorMsg += error.message;
                }
                
                showStatus('addStudentStatus', errorMsg, 'error');
                
                setTimeout(() => {
                    showStatus('addStudentStatus', 
                        'üì± H∆∞·ªõng d·∫´n c·∫•p quy·ªÅn:\n' +
                        '1. Nh·∫•n v√†o icon kh√≥a/th√¥ng tin b√™n tr√°i thanh ƒë·ªãa ch·ªâ\n' +
                        '2. T√¨m m·ª•c "Camera" v√† ch·ªçn "Cho ph√©p"\n' +
                        '3. T·∫£i l·∫°i trang v√† th·ª≠ l·∫°i', 
                        'error'
                    );
                }, 6000);
            }
        }

        async function flipCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        }

        async function flipCamera2() {
            currentFacingMode2 = currentFacingMode2 === 'user' ? 'environment' : 'user';
            await startCamera2();
        }

        function capturePhoto() {
            const video = document.getElementById('video2');
            const canvas = document.getElementById('canvas2');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // L·∫≠t ng∆∞·ª£c ·∫£nh ƒë·ªÉ match v·ªõi video ƒë√£ mirror
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0);
            context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('capturedImage').src = capturedImageData;
            document.getElementById('capturedImage').style.display = 'block';
            document.getElementById('video2').style.display = 'none';
            
            showStatus('addStudentStatus', '‚úì ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng', 'success');
        }

        function saveStudent() {
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();

            if (!studentId || !studentName || !studentClass) {
                showStatus('addStudentStatus', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }

            if (!capturedImageData) {
                showStatus('addStudentStatus', 'Vui l√≤ng ch·ª•p ·∫£nh h·ªçc sinh', 'error');
                return;
            }

            const students = DB.getStudents();

            if (students[studentId]) {
                showStatus('addStudentStatus', 'M√£ h·ªçc sinh ƒë√£ t·ªìn t·∫°i', 'error');
                return;
            }

            students[studentId] = {
                id: studentId,
                name: studentName,
                class: studentClass,
                photo: capturedImageData,
                createdAt: new Date().toISOString()
            };

            DB.saveStudents(students);

            showStatus('addStudentStatus', `‚úì ƒê√£ th√™m h·ªçc sinh: ${studentName}`, 'success');
            
            // Reset form
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            capturedImageData = null;
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('video2').style.display = 'block';
            
            updateStats();
        }

        function takeAttendance() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // L·∫≠t ng∆∞·ª£c ·∫£nh ƒë·ªÉ match v·ªõi video ƒë√£ mirror
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0);
            context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

            const currentImageData = canvas.toDataURL('image/jpeg', 0.8);

            // T√¨m h·ªçc sinh kh·ªõp b·∫±ng c√°ch so s√°nh ·∫£nh
            const students = DB.getStudents();
            let foundStudent = null;

            // Gi·∫£i ph√°p ƒë∆°n gi·∫£n: cho ph√©p ch·ªçn h·ªçc sinh t·ª´ danh s√°ch
            const studentKeys = Object.keys(students);
            
            if (studentKeys.length === 0) {
                showStatus('attendanceStatus', 'Ch∆∞a c√≥ h·ªçc sinh n√†o trong h·ªá th·ªëng', 'error');
                return;
            }

            // Hi·ªÉn th·ªã danh s√°ch ƒë·ªÉ ch·ªçn (v√¨ nh·∫≠n di·ªán khu√¥n m·∫∑t c·∫ßn th∆∞ vi·ªán ph·ª©c t·∫°p)
            const studentId = prompt('Nh·∫≠p m√£ h·ªçc sinh ƒë·ªÉ ƒëi·ªÉm danh:\n\n' + 
                studentKeys.map(id => `${id} - ${students[id].name}`).join('\n'));

            if (!studentId || !students[studentId]) {
                showStatus('attendanceStatus', 'Kh√¥ng t√¨m th·∫•y h·ªçc sinh', 'error');
                return;
            }

            foundStudent = students[studentId];

            const attendance = DB.getAttendance();
            const today = new Date().toLocaleDateString('vi-VN');
            
            // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
            const alreadyMarked = attendance.some(
                record => record.studentId === foundStudent.id && record.date === today
            );

            if (alreadyMarked) {
                showStatus('attendanceStatus', `${foundStudent.name} ƒë√£ ƒëi·ªÉm danh h√¥m nay r·ªìi`, 'error');
                return;
            }

            // Th√™m b·∫£n ghi ƒëi·ªÉm danh
            attendance.push({
                studentId: foundStudent.id,
                studentName: foundStudent.name,
                studentClass: foundStudent.class,
                date: today,
                time: new Date().toLocaleTimeString('vi-VN'),
                timestamp: new Date().toISOString(),
                photo: currentImageData
            });

            DB.saveAttendance(attendance);

            showStatus('attendanceStatus', 
                `‚úì ƒêi·ªÉm danh th√†nh c√¥ng: ${foundStudent.name} (${foundStudent.id})`, 
                'success');
            
            updateStats();
        }

        function loadStudentList() {
            const students = DB.getStudents();
            const studentList = document.getElementById('studentList');

            if (Object.keys(students).length === 0) {
                studentList.innerHTML = '<p style="text-align:center;color:#6c757d;">Ch∆∞a c√≥ h·ªçc sinh n√†o</p>';
                return;
            }

            const listHtml = Object.values(students).map(student => `
                <div class="student-item">
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-id">M√£: ${student.id} | L·ªõp: ${student.class}</div>
                    </div>
                    <button class="btn-delete" onclick="deleteStudent('${student.id}')">X√≥a</button>
                </div>
            `).join('');

            studentList.innerHTML = listHtml;
        }

        function deleteStudent(studentId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y?')) return;

            const students = DB.getStudents();
            delete students[studentId];
            DB.saveStudents(students);

            loadStudentList();
            updateStats();
        }

        function loadAttendanceHistory() {
            const attendance = DB.getAttendance();
            const today = new Date().toLocaleDateString('vi-VN');
            const historyDiv = document.getElementById('attendanceHistory');

            const todayRecords = attendance.filter(record => record.date === today);

            if (todayRecords.length === 0) {
                historyDiv.innerHTML = '<p style="text-align:center;color:#6c757d;">Ch∆∞a c√≥ b·∫£n ghi n√†o h√¥m nay</p>';
                return;
            }

            const historyHtml = todayRecords.map(record => `
                <div class="attendance-record">
                    <div class="student-name">${record.studentName} (${record.studentId})</div>
                    <div class="student-id">L·ªõp: ${record.studentClass}</div>
                    <div class="attendance-time">‚è∞ ${record.time}</div>
                </div>
            `).join('');

            historyDiv.innerHTML = historyHtml;
        }

        function updateStats() {
            const students = DB.getStudents();
            const attendance = DB.getAttendance();
            const today = new Date().toLocaleDateString('vi-VN');

            const totalStudents = Object.keys(students).length;
            const todayAttendance = attendance.filter(record => record.date === today).length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('todayAttendance').textContent = todayAttendance;
        }

        function exportToCSV() {
            const attendance = DB.getAttendance();
            const today = new Date().toLocaleDateString('vi-VN');
            const todayRecords = attendance.filter(record => record.date === today);

            if (todayRecords.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh h√¥m nay');
                return;
            }

            let csv = 'STT,M√£ h·ªçc sinh,H·ªç v√† t√™n,L·ªõp,Ng√†y,Gi·ªù\n';
            
            todayRecords.forEach((record, index) => {
                csv += `${index + 1},${record.studentId},${record.studentName},${record.studentClass},${record.date},${record.time}\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `diem_danh_${today.replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatus('attendanceStatus', '‚úì ƒê√£ xu·∫•t file CSV th√†nh c√¥ng', 'success');
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu?\n\nƒêi·ªÅu n√†y s·∫Ω x√≥a:\n- T·∫•t c·∫£ h·ªçc sinh\n- T·∫•t c·∫£ l·ªãch s·ª≠ ƒëi·ªÉm danh\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!')) {
                return;
            }

            if (!confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi: X√≥a to√†n b·ªô d·ªØ li·ªáu?')) {
                return;
            }

            localStorage.clear();
            alert('‚úì ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu');
            
            loadStudentList();
            loadAttendanceHistory();
            updateStats();
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // Kh·ªüi t·∫°o khi load trang
        window.onload = async function() {
            updateStats();
            
            // Ki·ªÉm tra h·ªó tr·ª£ camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('‚ö†Ô∏è Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ camera.\n\nVui l√≤ng s·ª≠ d·ª•ng Chrome, Firefox, Safari ho·∫∑c Edge phi√™n b·∫£n m·ªõi nh·∫•t.');
                return;
            }
            
            // Ki·ªÉm tra HTTPS (b·∫Øt bu·ªôc tr√™n m·ªôt s·ªë tr√¨nh duy·ªát)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                console.warn('‚ö†Ô∏è Camera c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông tr√™n HTTP. N√™n s·ª≠ d·ª•ng HTTPS.');
            }
            
            // Y√äU C·∫¶U QUY·ªÄN CAMERA NGAY KHI V√ÄO TRANG
            try {
                showPermissionDialog();
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' },
                    audio: false
                });
                
                // D·ª´ng stream sau khi xin quy·ªÅn (ch·ªâ xin quy·ªÅn th√¥i)
                stream.getTracks().forEach(track => track.stop());
                
                hidePermissionDialog();
                showWelcomeMessage();
            } catch (error) {
                hidePermissionDialog();
                showPermissionError(error);
            }
        };
        
        function showPermissionDialog() {
            const dialogHtml = `
                <div id="permissionDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì∑</div>
                        <h2 style="color: #667eea; margin-bottom: 15px;">C·∫•p quy·ªÅn Camera</h2>
                        <p style="color: #666; margin-bottom: 20px;">·ª®ng d·ª•ng c·∫ßn quy·ªÅn truy c·∫≠p camera ƒë·ªÉ ch·ª•p ·∫£nh h·ªçc sinh v√† ƒëi·ªÉm danh.</p>
                        <div style="display: inline-block; padding: 10px 20px; background: #f0f0f0; border-radius: 8px;">
                            <div style="font-size: 24px; animation: spin 1s linear infinite;">‚è≥</div>
                            <p style="margin-top: 10px; color: #666;">ƒêang xin quy·ªÅn...</p>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
        }
        
        function hidePermissionDialog() {
            const dialog = document.getElementById('permissionDialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        function showWelcomeMessage() {
            const welcomeHtml = `
                <div id="welcomeMessage" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 9999; animation: slideDown 0.3s ease;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">‚úÖ</span>
                        <div>
                            <strong>Quy·ªÅn camera ƒë√£ ƒë∆∞·ª£c c·∫•p!</strong>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 3px;">B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng</div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes slideDown {
                        from {
                            top: -100px;
                            opacity: 0;
                        }
                        to {
                            top: 20px;
                            opacity: 1;
                        }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', welcomeHtml);
            
            setTimeout(() => {
                const msg = document.getElementById('welcomeMessage');
                if (msg) {
                    msg.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => msg.remove(), 300);
                }
            }, 3000);
        }
        
        function showPermissionError(error) {
            let errorTitle = 'Kh√¥ng th·ªÉ truy c·∫≠p camera';
            let errorMessage = '';
            let instructions = '';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMessage = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p camera.';
                instructions = `
                    <strong style="color: #dc3545;">C√°ch c·∫•p quy·ªÅn:</strong><br><br>
                    <div style="text-align: left; padding: 0 20px;">
                        <strong>üì± Chrome Android:</strong><br>
                        1. Nh·∫•n v√†o <strong>icon kh√≥a</strong> (üîí) tr√™n thanh ƒë·ªãa ch·ªâ<br>
                        2. Ch·ªçn <strong>"Quy·ªÅn"</strong> ho·∫∑c <strong>"C√†i ƒë·∫∑t trang web"</strong><br>
                        3. T√¨m <strong>"Camera"</strong> ‚Üí Ch·ªçn <strong>"Cho ph√©p"</strong><br>
                        4. T·∫£i l·∫°i trang (F5)<br><br>
                        
                        <strong>üçé Safari iOS:</strong><br>
                        1. V√†o <strong>C√†i ƒë·∫∑t</strong> ‚Üí <strong>Safari</strong><br>
                        2. T√¨m <strong>"Camera"</strong> ‚Üí Ch·ªçn <strong>"H·ªèi"</strong> ho·∫∑c <strong>"Cho ph√©p"</strong><br>
                        3. T·∫£i l·∫°i trang<br><br>
                        
                        <strong>ü¶ä Firefox:</strong><br>
                        1. Nh·∫•n v√†o <strong>icon kh√≥a</strong> (üîí)<br>
                        2. Ch·ªçn <strong>"Quy·ªÅn"</strong><br>
                        3. B·∫≠t <strong>"Camera"</strong> ON<br>
                        4. T·∫£i l·∫°i trang
                    </div>
                `;
            } else if (error.name === 'NotFoundError') {
                errorMessage = 'Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã.';
                instructions = 'Vui l√≤ng ki·ªÉm tra xem thi·∫øt b·ªã c√≥ camera kh√¥ng ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c.';
            } else if (error.name === 'NotReadableError') {
                errorMessage = 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c.';
                instructions = 'Vui l√≤ng ƒë√≥ng c√°c ·ª©ng d·ª•ng kh√°c ƒëang d√πng camera v√† t·∫£i l·∫°i trang.';
            } else {
                errorMessage = error.message;
                instructions = 'Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát v√† th·ª≠ l·∫°i.';
            }
            
            const errorHtml = `
                <div id="permissionError" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                        <div style="font-size: 48px; margin-bottom: 15px; text-align: center;">‚ö†Ô∏è</div>
                        <h2 style="color: #dc3545; margin-bottom: 15px; text-align: center;">${errorTitle}</h2>
                        <p style="color: #666; margin-bottom: 20px; text-align: center;">${errorMessage}</p>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; line-height: 1.8; font-size: 14px;">
                            ${instructions}
                        </div>
                        <div style="text-align: center;">
                            <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;">
                                üîÑ T·∫£i l·∫°i trang
                            </button>
                            <button onclick="document.getElementById('permissionError').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                                ‚è≠Ô∏è B·ªè qua (d√πng sau)
                            </button>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; font-size: 13px; color: #856404;">
                            <strong>üí° M·∫πo:</strong> B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng "Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán" n·∫øu camera kh√¥ng ho·∫°t ƒë·ªông.
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', errorHtml);
        }
    </script>
</body>
</html>